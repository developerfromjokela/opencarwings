{% extends 'ui/base.html'%}
{% load math_filters %}
{% load static %}
{% block title %} {{car.nickname}} {% endblock %}
{% load i18n %}
{% load units %}
{% load l10n %}
{% block content %}
    <!-- Main Content -->
    <div class="max-w-6xl mx-auto py-6 px-4 sm:px-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
            <div>
                <a href="/" class="inline-block mt-6 text-blue-500 hover:underline text-sm sm:text-base">{% translate "Back to cars" %}</a>
                <h1 class="text-2xl sm:text-3xl font-semibold text-gray-800 align-center content-center flex flex-row items-center">
                    {% with 'car/'|add:car.color|add:'.png' as car_static %}
                      <img src="{% static car_static %}" style="padding-right: 15px; max-height: 60px; object-fit: cover"/>
                    {% endwith %}
                    <div class="cell-signal signal-{{ car.signal_level }} mr-3" style="display: {% if car.signal_level > 0 %}block{% else %}none{% endif %};">
                        <div class="signal-bars">
                          <div class="bar"></div>
                          <div class="bar"></div>
                          <div class="bar"></div>
                          <div class="bar"></div>
                          <div class="bar"></div>
                        </div>
                        <div class="carrier" id="carrier">{{ car.carrier }}</div>
                    </div>
                    {{ car.nickname }}
                    {% now "U" as current_time %}
                    {% if car.last_connection %}
                        {% with last_connection_time=car.last_connection|date:"U" %}
                            {% with diff_time=current_time|subtract:last_connection_time %}
                                <span id="connection-status" class="connection-status
                                    {% if diff_time <= 3600 or diff_time < 0 %}
                                        green
                                    {% elif diff_time >= 1209600 %}
                                        red
                                    {% else %}
                                        yellow
                                    {% endif %}
                                "></span>
                            {% endwith %}
                        {% endwith %}
                    {% else %}
                        <span id="connection-status" class="connection-status red"></span>
                    {% endif %}
                </h1>
            </div>
            <!-- Command Controls -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3">
                    <div class="spinner" id="command-spinner"></div>
                    <select id="command-select" class="w-full sm:w-auto border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for value, label in command_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button id="send-command" class="bg-blue-500 text-white rounded-md hover:bg-blue-600 w-full sm:w-auto">{% translate "Send command" %}</button>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="mb-6">
            {% if messages %}
                {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% endif %} px-4 py-3 rounded relative {% if message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% endif %} {% if message.tags == 'info' %}bg-blue-100 border-blue-400 text-blue-700{% endif %}" role="alert">
                        <strong class="font-bold">
                            {% if message.tags == 'success' %}{% translate "Success" %}!{% endif %}
                            {% if message.tags == 'error' %}{% translate "Error" %}!{% endif %}
                            {% if message.tags == 'info' %}{% translate "Notice" %}:{% endif %}
                            {% if message.tags == 'warn' %}{% translate "Warning" %}:{% endif %}
                        </strong>
                        <span class="block sm:inline">{{ message }}</span>
                        <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.style.display='none';">
                            <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <title>{% translate "Close" %}</title>
                                <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                            </svg>
                        </span>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="tab-nav-container relative">
          <button class="scroll-arrow left-arrow absolute left-0 top-1/2 transform -translate-y-1/2 bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>

          <div class="tab-nav border-b border-gray-200 flex overflow-x-auto whitespace-nowrap scroll-smooth hide-scrollbar">
            <button class="tab-btn px-3 py-2 hover:text-blue-500 focus:outline-none {% if not show_settings %}text-blue-500 border-b-2 border-blue-500{% else %}text-gray-600{% endif %} text-sm sm:text-base" data-tab="overview">{% translate "Overview" %}</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="basic-info">{% translate "Basic Info" %}</button>
            <a href="/car/{{ car.vin }}/probeviewer" class="px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base">{% translate "Vehicle journal" %}<span class="ml-2 bg-blue-500 text-white text-xs font-medium me-2 px-2.5 py-0.5 rounded-sm">{% translate "New!" %}</span></a>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="tcu-config">{% translate "TCU Configuration" %}</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="ev-status">{% translate "EV Status" %}</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="location">{% translate "Location" %}</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="routeplanner">{% translate "Route Planner" %}</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="carwings">CARWINGS</button>
            <button class="tab-btn px-3 py-2 text-gray-600 hover:text-blue-500 focus:outline-none text-sm sm:text-base" data-tab="recent-alerts">{% translate "Recent Alerts" %}</button>
            <button class="tab-btn px-3 py-2 hover:text-blue-500 focus:outline-none {% if show_settings %}text-blue-500 border-b-2 border-blue-500{% else %}text-gray-600{% endif %} text-sm sm:text-base" data-tab="settings">{% translate "Settings" %}</button>
          </div>

          <button class="scroll-arrow right-arrow absolute right-0 top-1/2 transform -translate-y-1/2 bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>

        <!-- Tab Content -->
        <div class="mt-6 bg-white p-4 sm:p-6 rounded-lg shadow-md">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content {% if not show_settings %}active{% endif %}">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">{% translate "Overview" %}</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Small Map -->
                    <div id="overview-map" class="map status-box flex flex-col items-center" style="padding: 0;">
                    </div>
                    <!-- Range with AC On -->
                    <div class="status-box">
                        <dt>{% translate "Range (AC On)" %}</dt>
                        <dd id="overview-range-acon">{% local_dist car.ev_info.range_acon decimals=0 %}</dd>
                    </div>
                    <!-- Range with AC Off -->
                    <div class="status-box">
                        <dt>{% translate "Range (AC Off)" %}</dt>
                        <dd id="overview-range-acoff">{% local_dist car.ev_info.range_acoff decimals=0 %}</dd>
                    </div>
                    <!-- State of Charge -->
                    <div class="status-box">
                        {% if car.ev_info.soc_display > 0 %}
                        <dt>{% translate "State of Charge" %}</dt>
                        <dd id="overview-soc">{{ car.ev_info.soc_display|floatformat:1 }}%</dd>
                        {% else %}
                        <dt>{% translate "State of Charge" %} ({% translate "Nominal" %})</dt>
                        <dd id="overview-soc">{{ car.ev_info.soc|floatformat:1 }}%</dd>
                        {% endif %}
                    </div>
                </div>
                <!-- Charge Bar and Additional Status -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Charge Bar -->
                    <div class="col-span-1 sm:col-span-2">
                        <div class="charge-bar-container">
                            <div class="charge-bar" id="charge-bar">
                                {% for i in "xxxxxxxxxxxx" %}
                                    <div class="charge-segment {% if forloop.counter0 < car.ev_info.charge_bars %}{% if forloop.counter0 < 2 %}low{% else %}filled{% endif %}{% else %}empty{% endif %}"></div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="charge-labels">
                            <span>{% translate "EMPTY" %}</span>
                            <span>{% translate "FULL" %}</span>
                        </div>
                    </div>
                    <!-- Charge time -->
                    <div class="status-box">
                        <dt>{% translate "Charge time" %}</dt>
                        <div class="flex items-center justify-center">
                            <table id="charge-time-tbl" border="1">
                            </table>
                        </div>
                    </div>
                    <!-- Charge Cable Status -->
                    <div class="status-box">
                        <dt>{% translate "Charge Cable" %}</dt>
                        {% if car.ev_info.quick_charging %}
                        <dd id="overview-plugged-in">CHAdeMO</dd>
                        {% else %}
                        <dd id="overview-plugged-in">{{ car.ev_info.plugged_in|yesno:_("Plugged In,Unplugged") }}</dd>
                        {% endif %}
                    </div>
                    <!-- Car Status -->
                    <div class="status-box">
                        <dt>{% translate "Car status" %}</dt>
                        <dd id="overview-car-status">
                            {% if car.ev_info.car_running %}
                                {% if car.ev_info.car_gear == 0 %}
                                    {% translate "On" %} ({% translate "Parked" %})
                                {% else %}
                                    {% translate "On" %} ({% translate "Driving" %})
                                {% endif %}
                            {% else %}
                                {% if car.ev_info.charge_finish %}
                                    {% translate "Charging finished" %}
                                {% elif car.ev_info.charging %}
                                    {% translate "Charging" %}
                                {% elif car.ev_info.batt_heater_status %}
                                    {% translate "Battery heater active" %}
                                {% else %}
                                    {% translate "Off" %}
                                {% endif %}
                            {% endif %}
                        </dd>
                    </div>
                    <!-- AC Status -->
                    <div class="status-box">
                        <dt>{% translate "AC Status" %}</dt>
                        <div class="flex flex-row align-center justify-center items-center gap-4">
                            <p id="overview-ac-status">{{ car.ev_info.ac_status|yesno:_("On,Off") }}</p>
                        <div id="fan-icon" class="fan-icon {% if car.ev_info.ac_status %}spinning{% endif %}">
<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M424-80q-51 0-77.5-30.5T320-180q0-26 11.5-50.5T367-271q22-14 35.5-36t18.5-47l-12-6q-6-3-11-7l-92 33q-17 6-33 10t-33 4q-63 0-111.5-55T80-536q0-51 30.5-77.5T179-640q26 0 51 11.5t41 35.5q14 22 36 35.5t47 18.5l6-12q3-6 7-11l-33-92q-6-17-10-33t-4-32q0-64 55-112.5T536-880q51 0 77.5 30.5T640-781q0 26-11.5 51T593-689q-22 14-35.5 36T539-606l12 6q6 3 11 7l92-34q17-6 32.5-9.5T719-640q81 0 121 67t40 149q0 51-32 77.5T777-320q-25 0-48.5-11.5T689-367q-14-22-36-35.5T606-421l-6 12q-3 6-7 11l33 92q6 16 10 30.5t4 30.5q1 65-54 115T424-80Zm56-340q25 0 42.5-17.5T540-480q0-25-17.5-42.5T480-540q-25 0-42.5 17.5T420-480q0 25 17.5 42.5T480-420Zm-46-192q6-2 12.5-3.5T459-618q8-42 30.5-78t59.5-60q5-4 8-10t3-15q0-8-6-13.5t-18-5.5q-38 0-86 16.5T400-719q0 9 2.5 17t4.5 15l27 75ZM240-400q14 0 33-7l75-27q-2-6-3.5-12.5T342-459q-42-8-78-30.5T204-549q-4-5-10.5-8t-14.5-3q-9 0-14 6t-5 18q0 54 20.5 95t59.5 41Zm184 240q47 0 92.5-19t43.5-66q0-8-2.5-15t-4.5-13l-27-75q-6 2-12.5 3.5T501-342q-8 42-30.5 78T411-204q-5 4-8.5 10.5T400-180q1 8 6 14t18 6Zm353-240q9 0 16-5t7-19q0-38-16-86.5T719-560q-9 0-17 2t-15 4l-75 28q2 6 3.5 12.5T618-501q42 8 78 30.5t60 59.5q3 5 9 8t12 3ZM618-501ZM459-618ZM342-459Zm159 117Z"/></svg>
                        </div>
                        </div>
                    </div>
                </div>
                <!-- Last Updated -->
                <div class="mt-4 text-sm text-gray-600">
                    {% translate "Last Updated" %}: <span id="overview-last-updated">{{ car.ev_info.last_updated|default:"N/A"|date:"Y-m-d H:i" }}</span>
                </div>
            </div>

            <!-- Basic Info -->
            <div id="basic-info" class="tab-content">
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 text-sm sm:text-base">
                    <div><dt class="text-gray-700 font-semibold">VIN:</dt><dd class="text-gray-600">{{ car.vin }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Odometer" %}:</dt><dd class="text-gray-600" id="odometer">{% if car.odometer > 0 %}{% local_dist car.odometer decimals=0 %}{% else %}--{% endif %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Navi version" %}:</dt><dd class="text-gray-600" id="navi_version">{{ car.navi_version|default:"--"  }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Map version" %}:</dt><dd class="text-gray-600" id="map_version">{{ car.map_version|default:"--"  }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "TCU version (from navi)" %}:</dt><dd class="text-gray-600" id="tcu_version">{{ car.tcu_version|default:"--"  }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "TCU version (from TCU)" %}:</dt><dd class="text-gray-600" id="tcu_version2">{{ car.tcu_ver|default:"--" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Vehicle Code" %} 1:</dt><dd class="text-gray-600">{{ car.vehicle_code1 }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Vehicle Code" %} 2:</dt><dd class="text-gray-600">{{ car.vehicle_code2 }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Vehicle Code" %} 3:</dt><dd class="text-gray-600">{{ car.vehicle_code3 }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Vehicle Code" %} 4:</dt><dd class="text-gray-600">{{ car.vehicle_code4 }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">TCU ID:</dt><dd class="text-gray-600">{{ car.tcu_model|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">Navi ID:</dt><dd class="text-gray-600">{{ car.tcu_serial|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">SIM ID:</dt><dd class="text-gray-600">{{ car.iccid|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Last Connection" %}:</dt><dd class="text-gray-600" id="last_connection">{{ car.last_connection|default:"Never"|date:"Y-m-d H:i" }}</dd></div>
                </dl>
            </div>

            <!-- TCU Configuration -->
            <div id="tcu-config" class="tab-content">
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 text-sm sm:text-base">
                    <div><dt class="text-gray-700 font-semibold">{% translate "PPP Dial Code" %}:</dt><dd class="text-gray-600">{{ car.tcu_configuration.dial_code|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">APN:</dt><dd class="text-gray-600">{{ car.tcu_configuration.apn|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">PPP {% translate "Username" %}:</dt><dd class="text-gray-600">{{ car.tcu_configuration.apn_user|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">PPP {% translate "Password" %}:</dt><dd class="text-gray-600">{{ car.tcu_configuration.apn_password|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">DNS1:</dt><dd class="text-gray-600">{{ car.tcu_configuration.dns1|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">DNS2:</dt><dd class="text-gray-600">{{ car.tcu_configuration.dns2|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Server" %} URL:</dt><dd class="text-gray-600">{{ car.tcu_configuration.server_url|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Proxy" %} URL:</dt><dd class="text-gray-600">{{ car.tcu_configuration.proxy_url|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Connection Type" %}:</dt><dd class="text-gray-600">{{ car.tcu_configuration.connection_type|default:"N/A" }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Last Updated" %}:</dt><dd class="text-gray-600">{{ car.tcu_configuration.last_updated|default:"N/A"|date:"Y-m-d H:i" }}</dd></div>
                </dl>
            </div>

            <!-- EV Status -->
            <div id="ev-status" class="tab-content">
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 text-sm sm:text-base">
                    <div><dt class="text-gray-700 font-semibold">{% translate "Car on" %}:</dt><dd class="text-gray-600" id="car_running">{{ car.ev_info.car_running|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Gear" %}:</dt><dd class="text-gray-600" id="car_gear">{{ car.ev_info.car_gear }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Charge time" %} (120V/L1):</dt><dd class="text-gray-600" id="limit_chg_time">{% if car.ev_info.limit_chg_time == 2047 or car.ev_info.limit_chg_time < 1 %}--:--{% else %}{{ car.ev_info.limit_chg_time }}{% endif %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Charge time" %} (240V/L2):</dt><dd class="text-gray-600" id="full_chg_time">{% if car.ev_info.full_chg_time == 2047 or car.ev_info.full_chg_time < 1 %}--:--{% else %}{{ car.ev_info.full_chg_time }}{% endif %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "6kW OBC exists" %}:</dt><dd class="text-gray-600" id="obc_6kw_avail">{{ car.ev_info.obc_6kw_avail|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Charge time" %} (6.6KW):</dt><dd class="text-gray-600" id="6kw_time">{% if car.ev_info.obc_6kw == 2047 or car.ev_info.obc_6kw == 4095 or car.ev_info.obc_6kw < 1 %}--:--{% else %}{{ car.ev_info.obc_6kw }}{% endif %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Charge bars" %}:</dt><dd class="text-gray-600" id="charge_bars">{{ car.ev_info.charge_bars }} / 12</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Capacity bars" %}:</dt><dd class="text-gray-600" id="cap_bars">{{ car.ev_info.cap_bars }} %</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "State of Charge" %} ({% translate "Display" %}):</dt><dd class="text-gray-600" id="soc_display">{{ car.ev_info.soc_display|floatformat:3 }}%</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "State of Charge" %} ({% translate "Nominal" %}):</dt><dd class="text-gray-600" id="soc">{{ car.ev_info.soc|floatformat:3 }}%</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "State of Health" %}:</dt><dd class="text-gray-600" id="soh">{{ car.ev_info.soh }}%</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Remaining kWh" %}:</dt><dd class="text-gray-600" id="remaining_kwh">{{ car.ev_info.wh_content|divide:1000 }} kWh</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Range (AC On)" %}:</dt><dd class="text-gray-600" id="range_acon">{% local_dist car.ev_info.range_acon decimals=0 %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Range (AC Off)" %}:</dt><dd class="text-gray-600" id="range_acoff">{% local_dist car.ev_info.range_acoff decimals=0 %}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Plugged in" %}:</dt><dd class="text-gray-600" id="plugged_in">{{ car.ev_info.plugged_in|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Charging" %}:</dt><dd class="text-gray-600" id="charging">{{ car.ev_info.charging|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Quick-charging" %}:</dt><dd class="text-gray-600" id="quick_charging">{{ car.ev_info.quick_charging|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Preconditioning (A/C)" %}:</dt><dd class="text-gray-600" id="ac_status">{{ car.ev_info.ac_status|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "GIDs remaining" %}:</dt><dd class="text-gray-600" id="gids">{{ car.ev_info.gids }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Battery heater exists" %}:</dt><dd class="text-gray-600" id="batt_heater_avail">{{ car.ev_info.batt_heater_avail|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Battery heater active" %}:</dt><dd class="text-gray-600" id="batt_heater_status">{{ car.ev_info.batt_heater_status|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Counter" %}:</dt><dd class="text-gray-600" id="counter">{{ car.ev_info.counter }}</dd></div>
                    <div><dt class="text-gray-700 font-semibold">{% translate "Last Updated" %}:</dt><dd class="text-gray-600" id="ev_last_updated">{{ car.ev_info.last_updated|default:"N/A"|date:"Y-m-d H:i" }}</dd></div>
                </dl>
            </div>

            <!-- Location -->
            <div id="location" class="tab-content">
                <div id="map" class="map mb-4"></div>
                <h2 class="text-lg font-semibold text-gray-800 mt-4 flex items-center">{% translate "Send location to car" %}<div class="spinner ml-2" id="send-to-car-spinner"></div></h2>
                <form id="send-to-car-search-form">
                    <input type="search" required minlength="2" placeholder="{% translate "Search for locations or enter google/apple maps link" %}" id="send-to-car-search" class="w-full p-2 border rounded mt-1">
                </form>
                <div id="send-to-car-results" class="mt-2">
                    {% if car.send_to_car_location %}
                        {% translate "Last shared location" %}: {{ car.send_to_car_location.name }}
                    {% else %}
                        {% translate "No past shared location" %}
                    {% endif %}
                </div>
                <button class="btn-s-disabled text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5 " id="send-to-car-submit" disabled="disabled">{% translate "Send" %}</button>
                <hr class="mt-2 mb-2"/>
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 text-sm sm:text-base">
                    <div><dt class="text-gray-700">{% translate "At Home" %}:</dt><dd class="text-gray-600" id="home">{{ car.location.home|yesno:_("Yes,No") }}</dd></div>
                    <div><dt class="text-gray-700">{% translate "Last Updated" %}:</dt><dd class="text-gray-600" id="loc_last_updated">{{ car.location.last_updated|default:"N/A"|date:"Y-m-d H:i" }}</dd></div>
                </dl>
            </div>

            <!-- Location -->
            <div id="routeplanner" class="tab-content">
                <div class="flex flex-col md:flex-row gap-3 sm:gap-4" style="min-height: 500px;">
                    <div id="routeplans" class="mb-6" style="min-width: 350px; max-width: 500px;">
                        <h2 class="text-lg font-semibold text-gray-800 mt-4 flex items-center">{% translate "Route plans" %} <button onclick="addNewPlan()" class="ml-2 px-2 py-1 text-xs font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none">{% translate "Add" %}</button></h2>
                        <div id="routeplans-list" class="mt-2 space-y-2">
                            {% for plan in car.route_plans.all %}
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                    <span class="text-gray-700 font-medium mx-3">{{ plan.name }}</span>
                                    <div class="flex space-x-2">
                                        <button
                                            onclick="editRoutePlan('{{ plan.id }}')"
                                            class="px-3 py-1 bg-blue-700 text-white rounded-md hover:bg-blue-600 transition text-sm"
                                        >
                                            {% translate "Edit" %}
                                        </button>
                                        <button
                                            onclick="deleteRoutePlan('{{ plan.id }}')"
                                            class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm"
                                        >
                                            {% translate "Delete" %}
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                            {% if car.route_plans.count == 0 %}
                                {% translate 'No route plans added' %}
                            {% endif %}
                        </div>
                    </div>
                    <div id="routeplan-editdialog" style="display: none;">
                        <h2 class="text-lg font-semibold text-gray-800 mt-4 flex items-center">{% translate "Add/Edit a route plan" %}<div class="spinner ml-2" id="routeplan-spinner"></div></h2>
                        <div id="routeplanner-compose" class="mt-2">
                            <input type="text" maxlength="30" id="routeplan-name" placeholder="{% translate "Name of the plan" %}" class="w-full p-1 border rounded mt-1"/>
                            <hr class="my-2"/>
                            <form id="rp-start-form" class="rp-wp-search mt-2">
                                <label for="rp-start" class="routeplan-title"><img class="routeplan-icon" src="{% static "chanicons/start.png" %}"/> {% translate "Starting point" %}</label>
                                <input type="search" required minlength="2" placeholder="{% translate "Search for locations or enter google/apple maps link" %}" id="rp-start" class="rp-searchfield w-full p-1 border rounded mt-1">
                                <div class="rp-search-results mt-2"></div>
                            </form>
                            <div id="rp-waypoints" class="ml-3">

                            </div>
                            <button class="font-medium text-blue-700 hover:underline" onclick="addWayPoint()">+ {% translate "Add waypoint" %}</button>
                            <form id="rp-finish-form" class="rp-wp-search mt-2">
                                <label for="rp-finish" class="routeplan-title"><img class="routeplan-icon" src="{% static "chanicons/destination.png" %}"/> {% translate "Destination point" %}</label>
                                <input type="search" required minlength="2" placeholder="{% translate "Search for locations or enter google/apple maps link" %}" id="rp-finish" class="rp-searchfield w-full p-1 border rounded mt-1">
                                <div class="rp-search-results mt-2"></div>
                            </form>
                            <button class="btn-s-disabled text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5 " id="routeplan-submit" disabled="disabled">{% translate "Save" %}</button>
                            <button class="text-white bg-gray-500 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5 " onclick="exitRoutePlanEditor()">{% translate "Cancel" %}</button>
                        </div>
                    </div>
                    <div id="routeplanmap" class="map mb-4 flex-1 rounded-md" style="min-height: 300px;"></div>
                </div>
            </div>

            <div id="carwings" class="tab-content" data-accordion="open">
                  <h2 id="favorite-heading">
                    <button type="button" class="collapsing-btn flex items-center justify-between w-full text-gray-900  p-5 font-medium rtl:text-right border border-b-0 border-gray-200 focus:ring-4 focus:ring-gray-200 gap-3" data-accordion-target="#favorite-body" aria-expanded="true" aria-controls="favorite-body">
                      <span>{% translate "Favorite channels" %}</span>
                      <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                      </svg>
                    </button>
                  </h2>
                  <div id="favorite-body" class="hidden px-2 py-4 grid grid-cols-1 md:grid-cols-2 gap-3" aria-labelledby="favorite-heading">
                      <div class="grid gap-3">
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">1.</b> <img class="inline h-4 mr-2" src="{% static channels.0.channels.0.icon %}"/> {{ channels.0.channels.0.name }}</div></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">2.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(2)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(2)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">3.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(3)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(3)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">4.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(4)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(4)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">5.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(5)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(5)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">6.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(6)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(6)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">7.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(7)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(7)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">8.</b> <img class="inline h-4 mr-2"><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(8)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(8)"><i class="mic material-symbols-outlined">delete</i></button></div>
                      </div>
                      <div class="grid gap-3">
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">9.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(9)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(9)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">10.</b> <img class="inline h-4 mr-2"><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(10)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(10)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">11.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(11)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(11)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">12.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(12)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(12)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">13.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(13)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(13)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">14.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(14)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(14)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">15.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(15)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(15)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">16.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No selected channel" %}</span></div><button onclick="editFvtChn(16)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrFvtChn(16)"><i class="mic material-symbols-outlined">delete</i></button></div>
                      </div>
                  </div>

                  <h2 id="custom-channels-heading">
                    <button type="button" class="collapsing-btn flex items-center justify-between w-full text-gray-900  p-5 font-medium rtl:text-right border border-gray-200 focus:ring-4 focus:ring-gray-200 gap-3" data-accordion-target="#custom-channels-body" aria-expanded="false" aria-controls="custom-channels-body">
                      <span>{% translate "Custom channels" %}</span>
                      <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                      </svg>
                    </button>
                  </h2>
                  <div id="custom-channels-body" class="hidden px-2 py-4 grid grid-cols-1 md:grid-cols-2 gap-3" aria-labelledby="custom-channels-body">
                       <div class="grid gap-3">
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">1.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(0)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(0)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">2.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(1)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(1)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">3.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(2)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(2)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">4.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(3)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(3)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">5.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(4)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(4)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">6.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(5)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(5)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">7.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(6)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(6)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">8.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(7)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(7)"><i class="mic material-symbols-outlined">delete</i></button></div>
                      </div>
                      <div class="grid gap-3">
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">9.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(8)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(8)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">10.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(9)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(9)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">11.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(10)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(10)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">12.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(11)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(11)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">13.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(12)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(12)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">14.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(13)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(13)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">15.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(14)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(14)"><i class="mic material-symbols-outlined">delete</i></button></div>
                          <div class="datachannel p-2 rounded-md bg-gray-100 flex flex-row items-center"><div class="flex-1 flex items-center"><b class="text-md mr-2">16.</b> <img class="inline h-4 mr-2"/><span class="datachannel-name">{% translate "No content" %}</span></div><button onclick="editCustomChn(15)" class="px-1"><i class="mic material-symbols-outlined">edit</i></button><button class="px-1" onclick="clrCustomChn(15)"><i class="mic material-symbols-outlined">delete</i></button></div>
                      </div>
                  </div>
                <button onclick="saveCarwingsSettings()" class="btn-s-disabled text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5 " id="carwings-save" disabled="disabled">{% translate "Save" %}</button>
            </div>

            <!-- Recent Alerts -->
            <div id="recent-alerts" class="tab-content">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm sm:text-base">
                        <thead>
                            <tr class="text-gray-700 border-b">
                                <th class="py-2">{% translate "Type" %}</th>
                                <th class="py-2">{% translate "Timestamp" %}</th>
                                <th class="py-2">{% translate "Additional Data" %}</th>
                            </tr>
                        </thead>
                        <tbody id="alerts-table">
                            {% for alert in alerts %}
                                <tr data-id="{{ alert.id }}" class="border-b text-gray-600">
                                    <td class="py-2">{{ alert.get_type_display }}</td>
                                    <td class="py-2">{{ alert.timestamp|date:"Y-m-d H:i" }}</td>
                                    <td class="py-2">{{ alert.additional_data|default:"N/A" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="tab-content {% if show_settings %}active{% endif %}">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">{% translate "Settings" %}</h2>

                <form method="post" class="mt-5">
                    {% csrf_token %}

                    <label class="block text-gray-700">{% translate "Nickname" %}</label>
                    <input type="text" value="{{car.nickname}}" maxlength="64" name="nickname" class="w-full p-2 border rounded mt-1" required>
                    <label class="block text-gray-700">Navi ID</label>
                    <input type="text" value="{{car.tcu_serial}}" maxlength="32" name="unit_id" class="w-full p-2 border rounded mt-1" required>
                    <label class="block text-gray-700 mt-2 ">TCU ID</label>
                    <input type="text" value="{{car.tcu_model}}" maxlength="32" name="tcu_id" class="w-full p-2 border rounded mt-1" required>
                    <label class="block text-gray-700 mt-2 ">SIM ID</label>
                    <input type="text" value="{{car.iccid}}"  maxlength="32" name="sim_id" class="w-full p-2 border rounded mt-1" required>
                    <div class="block mt-5">
                        <input type="checkbox" id="disable_auth" value="checked" {% if car.disable_auth %}checked{% endif %} maxlength="22" name="disable_auth" class="p-2 border rounded mt-1 checkboxinput ">
                        <label for="disable_auth">{% translate "Skip authentication from TCU" %}</label>
                        <span class="block text-sm text-gray-700 mt-1">{% translate "On AZE0 (2013) and newer LEAFs, username and password inserted to navi are not saved due to an error. In this case, check this box to skip the authentication" %}</span>
                    </div>

                    <hr class="my-3"/>

                    <div class="block mt-5">
                        <label class="block text-gray-700 mt-2 ">{% translate "Car color" %}</label>
                        <select name="color" class="w-full periodic-select sm:w-auto border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for value, label in car_color_choices %}
                                <option value="{{ value }}" {% if car.color == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="block" >
                        <label class="block text-gray-700 mt-2 ">{% translate "Maximum GIDs value" %}</label>
                        <input type="text" value="{{car.ev_info.max_gids}}" name="max_gids" class="w-full p-2 border rounded mt-1" required>
                        <span class="block text-sm text-gray-700 mt-1">{% translate "OpenCARWINGS will try to auto-detect your battery size and fill this field. For cars with swapped/replaced battery, please enter maximum amount of GIDS when battery is new (SoH 100%)." %}</span>
                    </div>

                    <div class="block mt-5{% if car.vehicle_code1 != 2 %} hidden{% endif %}">
                        <input type="checkbox" id="force_soc_display" value="checked" {% if car.ev_info.force_soc_display %}checked{% endif %} maxlength="22" name="force_soc_display" class="p-2 border rounded mt-1 checkboxinput">
                        <label for="force_soc_display">{% translate "Show calculated battery percentage" %}</label>
                        <span class="block text-sm text-gray-700 mt-1">{% translate "On AZE0 (>2013) generation cars, it is possible to see available battery capacity in percentage. For ZE0, such feature was never implemented. By enabling this option, 'display' percentage value will be calculated, it may be inaccurate." %}</span>
                    </div>

                    <hr class="my-3"/>

                    <div class="block mt-5">
                        <label class="block text-gray-700 mt-2 ">{% translate "Periodic data refresh interval" %}</label>
                        <select name="periodic_refresh" class="w-full periodic-select sm:w-auto border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for value, label in periodic_refresh_choices %}
                                <option value="{{ value }}" {% if car.periodic_refresh == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="block mt-5">
                        <label class="block text-gray-700 mt-2 ">{% translate "Periodic data refresh interval (while driving or charging)" %}</label>
                        <select name="periodic_refresh_running" class="w-full periodic-select sm:w-auto border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for value, label in periodic_refresh_running_choices %}
                                <option value="{{ value }}" {% if car.periodic_refresh_running == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="mt-4 mb-4"/>
                    <label class="mt-4">{% translate "SMS provider" %}</label>

                    {% for provider in providers %}
                    <div class="flex items-center my-2">
                        <input id="sms-radio-{{provider.id}}"
                               {% if provider.id == car.sms_config.provider %} checked {% endif %}
                               type="radio" value="{{provider.id}}" name="sms-provider" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500">
                        <label for="sms-radio-{{provider.id}}" class="ml-2 text-sm font-medium text-gray-900">{% translate provider.name %}</label>
                    </div>
                    {% endfor %}

                    {% for provider in providers %}
                    <div id="{{provider.id}}-fields" class="mt-4 space-y-4 hidden provider-fields">
                        {% for field in provider.fields %}
                        <div>
                            <label for="field-{{ field.0 }}" class="block mb-2 text-sm font-medium text-gray-900">{{ field.1 }}</label>
                            <input type="text" id="field-{{ field.0 }}" value="{{ car.sms_config|get_item:field.0 }}" maxlength="128" name="{{provider.id}}-{{ field.0 }}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        {% endfor %}
                        {% if provider.help %}
                        <div class="mt-4">
                            <div class="p-4 text-sm text-blue-800 rounded-lg bg-blue-50" role="alert">
                                {{provider.help}}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5" type="submit">{% translate "Save" %}</button>
                    <button class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 me-2 mb-2 mt-5" type="button" onclick="removeCarConfirm()">{% translate "Remove car" %}</button>

                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <button data-modal-target="carpin-modal" data-modal-toggle="carpin-modal" style="display: none;" type="button"></button>
    <div id="carpin-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow-sm">
                <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="carpin-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">{% translate "Close" %}</span>
                </button>
                <div class="p-4 md:p-5 text-center">
                    <h3 class="mb-5 text-lg font-normal text-gray-700">{% translate "Set car location as" %}</h3>
                        <button data-modal-hide="carpin-modal" onclick="setCarLocationInPlan(0)" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-500 focus:z-10 focus:ring-4 focus:ring-gray-100">{% translate "Starting point" %}</button>
                        <button data-modal-hide="carpin-modal" onclick="setCarLocationInPlan(1)" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-500 focus:z-10 focus:ring-4 focus:ring-gray-100">{% translate "Destination point" %}</button>
                </div>
            </div>
        </div>
    </div>

    <button data-modal-target="fvtchn-modal" data-modal-toggle="fvtchn-modal" style="display: none;" type="button"></button>
    <div id="fvtchn-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow-sm">
                <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="fvtchn-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">{% translate "Close" %}</span>
                </button>
                <div class="p-4 md:p-5 text-center" data-accordion="collapse">
                    <h3 class="mb-5 text-lg font-normal text-gray-700">{% translate "Select data channel" %}</h3>
                    {% for folder in channels %}
                       <h2 id="f-{{ folder.id }}-heading">
                        <button type="button" class="collapsing-btn flex items-center justify-between w-full text-gray-900  p-2 font-medium rtl:text-right border border-gray-200 focus:ring-4 focus:ring-gray-200 gap-3" data-accordion-target="#f-{{ folder.id }}-body" aria-expanded="false" aria-controls="f-{{ folder.id }}-body">
                          <span><img src="{% static folder.icon %}" class="inline h-4"/> {{ folder.name }}</span>
                          <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                          </svg>
                        </button>
                      </h2>
                      <div id="f-{{ folder.id }}-body" class="hidden px-2 py-4 grid grid-cols-1 gap-3" aria-labelledby="f-{{ folder.id }}-heading">
                        {% for channel in folder.channels %}
                            <button onclick="saveFvtChn({{ channel.id }})" type="button" class="flex border-gray-300 border border-t-0 border-x-0 items-center justify-between w-full text-gray-900 text-md font-medium rtl:text-right p-1">
                                 <span><img src="{% static channel.icon %}" class="inline h-4"/> {{ channel.name }}</span>
                            </button>
                        {% endfor %}
                      </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <button data-modal-target="customchn-modal" data-modal-toggle="customchn-modal" style="display: none;" type="button"></button>
    <div id="customchn-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow-sm">
                <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="customchn-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">{% translate "Close" %}</span>
                </button>
                <div class="p-4 md:p-5" data-accordion="collapse">
                    <form id="edit-customchnform">
                        <h3 class="mb-5 text-lg font-normal text-gray-700">{% translate "Edit data channel" %}</h3>
                        <label class="block text-gray-700">{% translate "Channel name" %}</label>
                        <input type="text" maxlength="30" id="chan-name" class="w-full p-2 border rounded mt-1" required>

                        <div class="block mt-5">
                            <label class="block text-gray-700 mt-2">{% translate "Channel icon" %}</label>
                            <div class="flex flex-row items-center gap-3">
                                <img class="inline h-6" src="{% static "chanicons/info.png" %}" id="chan-iconpreview"/>
                                <select id="chan-icon" onchange="document.getElementById('chan-iconpreview').src=staticRes+'chanicons/'+this.value" class="w-full periodic-select border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {% for icon in chan_icon_choices %}
                                        <option value="{{ icon.0 }}" ><img src="{% static "chanicons/"|add:icon.0 %}" class="inline h-4"/> {{ icon.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <label class="block mt-5 text-gray-700">{% translate "Data URL" %}</label>
                        <input type="url" maxlength="255" id="chan-url" placeholder="https://example.com/mycustomchannel" class="w-full p-2 border rounded mt-1" required>
                        <a href="{% static "data_guide.html" %}" target="_blank" class="block text-sm underline">{% translate "Data URL format and documentation" %}</a>

                        <div class="flex items-center mt-4">
                            <input id="chan-location" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm">
                            <label for="chan-location" class="ms-2 text-sm font-medium text-gray-900">{% translate "Allow sending current vehicle location" %}</label>
                        </div>

                        <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 mt-5" type="submit">{% translate "Save" %}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js"></script>
    {{ car.sms_config|json_script:"currentSmsConfig" }}

    {{ channels|json_script:"defchannels" }}

    <script>

        const imperial = {{ imperial }};

        const staticRes = "{% get_static_prefix %}";

        let currentSmsConfig = {stub: "{% translate "SMS from your device" %}"};

        try {
            currentSmsConfig = JSON.parse(document.getElementById('currentSmsConfig').textContent);
        } catch (e) {}

        let dataChannels = [];
        let allChannels = [];

        try {
            dataChannels = JSON.parse(document.getElementById('defchannels').textContent);
            for (let folder of dataChannels) {
                if (folder.channels)
                    allChannels = allChannels.concat(folder.channels);
            }
        } catch (e) {}

        let fvtChnData = null;
        let customChnData = null;

        const mapUrlRegex = /(([a-z0-9$\-_.+!*'(),;:&=]|%[0-9a-f]{2})+@)?(((25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])(\.(25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])){3})|([a-z0-9\-\u00C0-\u017F]+\.)+([a-zA-Z]{2,}))(\/(([a-zA-Z0-9$\-_.+!*'(),;:@&=]|%[0-9a-fA-F]{2})*(\/([a-zA-Z0-9$\-_.+!*'(),;:@&=]|%[0-9a-fA-F]{2})*)*)?(\?([a-zA-Z0-9$\-_.+!*'(),;:@&=\/?]|%[0-9a-fA-F]{2})*)?(\#([a-zA-Z0-9$\-_.+!*'(),;:@&=\/?]|%[0-9a-fA-F]{2})*)?)?$/;

        // Car info
        const carId = {{ car.id }};

        // Initialize maps
        let map;
        let overviewMap;
        let routeplanMap;
        let marker = null;
        let overviewMarker = null;
        let mapInitialized = false;
        let overviewMapInitialized = false;
        let carColor = null;
        let carName = null;

        let routePlans = [];
        let composingRoutePlan = {id: null};

        // Websocket client instance
        const webSockClient = new WebSocketClient("/ws/notif/", ws_connect, ws_msg, ws_err, ws_close, ws_reconnect)
        webSockClient.maxReconnectAttempts = 0;

        function escapeHtml(unsafe) {
              return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setSignalStrength(strength) {
          const signalDiv = document.querySelector('.cell-signal');
          signalDiv.className = 'cell-signal mr-3'; // Reset classes
          if (strength >= 1 && strength <= 5) {
              signalDiv.style.display = 'block';
            signalDiv.classList.add(`signal-${strength}`);
          } else {
              signalDiv.style.display = 'none';
          }
        }

        const distanceLocalize = (km, accuracy) => {
            if (imperial) {
                let value = (km * 0.621371).toFixed(accuracy);
                return `${value} mi`
            }
            return `${km.toFixed(accuracy)} km`
        }


        function updateMap(lat, lon, mapInstance, markerInstance, zoomLevel, isOverview = false) {
            if (lat && lon) {
                const latLng = [lat, lon];
                if (markerInstance) {
                    markerInstance.setLatLng(latLng);
                } else {
                    markerInstance = L.marker(latLng).addTo(mapInstance);
                    if (isOverview) {
                        overviewMarker = markerInstance;
                    } else {
                        marker = markerInstance;
                    }
                }
                mapInstance.setView(latLng, zoomLevel);
            } else if (markerInstance) {
                mapInstance.removeLayer(markerInstance);
                if (isOverview) {
                    overviewMarker = null;
                } else {
                    marker = null;
                }
                mapInstance.setView([0, 0], 2);
            }
            return markerInstance;
        }

        // Tab Switching with Map Fix
        document.addEventListener('DOMContentLoaded', () => {
            // map init
            map = L.map('map', { zoomControl: true });
            overviewMap = L.map('overview-map', { zoomControl: false });
            routeplanMap = L.map('routeplanmap', { zoomControl: true });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(overviewMap);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(routeplanMap);

            const tabNav = document.querySelector('.tab-nav');
            const leftArrow = document.querySelector('.left-arrow');
            const rightArrow = document.querySelector('.right-arrow');

            // Function to check scroll position and toggle arrows
            function updateArrows() {
                const isAtStart = tabNav.scrollLeft <= 0;
                const isAtEnd = tabNav.scrollLeft + tabNav.clientWidth >= tabNav.scrollWidth - 1;

                leftArrow.classList.toggle('hidden', isAtStart);
                rightArrow.classList.toggle('hidden', isAtEnd);
            }

            // Initial check for arrow visibility
            updateArrows();

            // Update arrows on scroll
            tabNav.addEventListener('scroll', updateArrows);

            // Scroll left on left arrow click
            leftArrow.addEventListener('click', () => {
            tabNav.scrollBy({ left: -200, behavior: 'smooth' });
            });

            // Scroll right on right arrow click
            rightArrow.addEventListener('click', () => {
            tabNav.scrollBy({ left: 200, behavior: 'smooth' });
            });

            // Update arrows on window resize
            window.addEventListener('resize', updateArrows);

            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-blue-500', 'border-b-2', 'border-blue-500');
                        btn.classList.add('text-gray-600');
                    });
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.remove('text-gray-600');
                    button.classList.add('text-blue-500', 'border-b-2', 'border-blue-500');
                    document.getElementById(tabId).classList.add('active');

                    if (tabId === 'location' && !mapInitialized) {
                        marker = updateMap({{ car.location.lat|default:"null"|unlocalize }}, {{ car.location.lon|default:"null"|unlocalize }}, map, marker, 15);
                        mapInitialized = true;
                    } else if (tabId === 'location') {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 300);
                    }

                    if (tabId === 'routeplanner') {
                        routeplanMap.invalidateSize();
                    }

                    if (tabId === 'overview' && !overviewMapInitialized) {
                        overviewMarker = updateMap({{ car.location.lat|default:"null"|unlocalize }}, {{ car.location.lon|default:"null"|unlocalize }}, overviewMap, overviewMarker, 15, true);
                        overviewMapInitialized = true;
                        setTimeout(() => {
                            overviewMap.invalidateSize();
                        }, 100);
                    } else if (tabId === 'overview') {
                        setTimeout(() => {
                            overviewMap.invalidateSize();
                        }, 100);
                    }
                });
            });

            // Initialize overview map on page load
            overviewMarker = updateMap({{ car.location.lat|default:"null"|unlocalize }}, {{ car.location.lon|default:"null"|unlocalize }}, overviewMap, overviewMarker, 15, true);
            const routeplanCarLatLon = [{{ car.location.lat|default:"null"|unlocalize }}, {{ car.location.lon|default:"null"|unlocalize }}];
            if (routeplanCarLatLon.length > 0 && routeplanCarLatLon[0]) {
                let carIcn = L.icon({
                    iconUrl: staticRes+`car/{{ car.color }}.png`,
                    iconSize:     [42, 25],
                    iconAnchor:   [10, 20],
                });
                L.marker(routeplanCarLatLon, {icon: carIcn}).addTo(routeplanMap).on('click', openDestCopyDialog);
                routeplanMap.fitBounds([routeplanCarLatLon], {padding: [12, 12]});
            }
            overviewMapInitialized = true;

            const radioButtons = document.querySelectorAll('input[name="sms-provider"]');
            const providerBoxes = document.querySelectorAll('.provider-fields');

            function updateFields() {
                providerBoxes.forEach(i => i.classList.add('hidden'))
                const selectedValue = document.querySelector('input[name="sms-provider"]:checked').value;
                document.getElementById(`${selectedValue}-fields`).classList.remove('hidden')
            }

            radioButtons.forEach(radio => {
                radio.addEventListener('change', updateFields);
            });

            // Initial call to show fields based on default selection
            updateFields();

            // listener for routeplan field
            document.getElementById('routeplan-name').addEventListener('input', (evt) => {
                if (!composingRoutePlan)
                    composingRoutePlan = {id: null};
                composingRoutePlan.name = evt.target.value;
                updateRoutePlannerState((evt.target.value.length > 0 && composingRoutePlan.count && composingRoutePlan.count > 1), false);
            });
        });

        // Send to car
        const sendToCarButton = document.getElementById('send-to-car-submit');
        const sendToCarSpinner = document.getElementById('send-to-car-spinner');
        const sendToCarSearch = document.getElementById('send-to-car-search');
        const sendToCarResults = document.getElementById('send-to-car-results');

        // Route planner
        const routePlanButton = document.getElementById('routeplan-submit');
        const routePlanSpinner = document.getElementById('routeplan-spinner');

        // Carwings
        const saveChanInfoButton = document.getElementById('carwings-save');

        // Command State Management
        const commandSelect = document.getElementById('command-select');
        const sendCommandButton = document.getElementById('send-command');
        const commandSpinner = document.getElementById('command-spinner');

        function updateCommandState(commandType, requested) {
            if ((commandType === -1 && requested) || commandType === 3) {
                commandSpinner.style.display = 'inline-block';
                sendCommandButton.disabled = true;
                sendCommandButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                commandSpinner.style.display = 'none';
                sendCommandButton.disabled = false;
                sendCommandButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateSendToCarState(enabled, searching) {
            sendToCarButton.disabled = enabled ? "" : "disabled";
            sendToCarSpinner.style.display = searching ? "inline-block" : "none";
        }

        function updateRoutePlannerState(enabled, searching) {
            routePlanButton.disabled = enabled ? "" : "disabled";
            routePlanSpinner.style.display = searching ? "inline-block" : "none";
        }

        function updateCarwingsState(enabled, saving) {
            commandSpinner.style.display = saving ? 'inline-block' : 'none';
            saveChanInfoButton.disabled = enabled ? "" : "disabled";
        }

        // Function to update the charge bar display
        function updateChargeBar(chargeBars, soc, isCharging, isQuickCharging) {
            const chargeBar = document.getElementById('charge-bar');
            const segments = chargeBar.children;

            // Update segments
            for (let i = 0; i < segments.length; i++) {
                segments[i].className = 'charge-segment';
                if (i < chargeBars) {
                    if (i < 2) {
                        segments[i].classList.add('low'); // Red for the first 2 bars
                    } else {
                        segments[i].classList.add('filled'); // Blue for the rest of the filled bars
                    }
                    // Make the last active segment blink if charging
                    if (isCharging && i === chargeBars - 1) {
                        segments[i].classList.add(isQuickCharging ? 'qc-blinking' : 'blinking');
                    }
                } else {
                    segments[i].classList.add('empty'); // Gray for empty bars
                }
            }
        }

        function updateChargingTimeTbl(data) {
            const table = document.getElementById('charge-time-tbl');
            table.innerHTML = '';

            data.forEach(item => {
                // Create a new row
                const row = document.createElement('tr');
                // Create the label cell
                const labelCell = document.createElement('td');
                labelCell.textContent = item.power; // Use textContent to prevent XSS
                row.appendChild(labelCell);

                // Create the value cell
                const valueCell = document.createElement('td');
                valueCell.textContent = (item.time === 4095 || item.time === 2047 || item.time === 0) ? '--:--' : convertMinsToHrsMins(item.time);

                row.appendChild(valueCell);

                // Append the row to the table
                table.appendChild(row);
            });
        }

        // Existing JavaScript
        const vin = "{{ car.vin }}";
        let lastAlertId = Math.max(...Array.from(document.querySelectorAll('#alerts-table tr'))
            .map(row => parseInt(row.dataset.id) || 0));

        const convertMinsToHrsMins = (mins) => {
            let h = Math.floor(mins / 60);
            let m = mins % 60;
            h = h < 10 ? '0' + h : h;
            m = m < 10 ? '0' + m : m;
            return `${h}:${m}`;
        };

        function removeCarConfirm() {
            if (confirm("Do you really want to delete this car?")) {
                fetch(`/api/car/${vin}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    window.location.href = "/"
                } else if (data.error) {
                    showNotification({title: '{% translate "Error sending command" %}', message: data.error ?? data, type: 'error'});
                }
            })
            .catch(error => {
                console.error('{% translate "Error sending command" %}:', error);
                showNotification({title: '{% translate "Error sending command" %}', message: error.error ?? error, type: 'error'});
            });
            }
        }

        function updateCarData() {
            fetch(`/api/car/${vin}/`)
                .then(response => response.json())
                .then(data => {
                    updateCarUIElements(data)
                })
                .catch(error => console.error('Error fetching car data:', error));
        }

        function updateCarUIElements(data) {
            if (data.sms_config) {
                currentSmsConfig = data.sms_config;
            }

            if (data.route_plans) {
                routePlans = data.route_plans;
                updateRoutePlans();
            }

            if (data.favorite_channels && fvtChnData == null) {
                fvtChnData = data.favorite_channels;
            }

            if (data.custom_channels && customChnData == null) {
                customChnData = data.custom_channels;
            }

            updateFvtChnItems();
            updateCustomChnItems();

            carColor = data.color;
            carName = data.nickname;

            // Update Overview Tab
            document.getElementById('overview-soc').textContent = data.ev_info.soc_display > 0 ? `${data.ev_info.soc_display.toFixed(1)}%` : `${data.ev_info.soc.toFixed(1)}%`;
            document.getElementById('overview-range-acon').textContent = distanceLocalize(data.ev_info.range_acon, 0);
            document.getElementById('overview-range-acoff').textContent = distanceLocalize(data.ev_info.range_acoff, 0)
            document.getElementById('overview-plugged-in').textContent = data.ev_info.quick_charging ? 'CHAdeMO' : (data.ev_info.plugged_in ? '{% translate "Plugged In" %}' : '{% translate "Unplugged" %}');
            // Update Car Status
            const carStatus = document.getElementById('overview-car-status');
            if (data.ev_info.car_running) {
                if (data.ev_info.car_gear === 0) {
                    carStatus.textContent = '{% translate "On" %} ({% translate "Parked" %})';
                } else {
                    carStatus.textContent = '{% translate "On" %} ({% translate "Driving" %})';
                }
            } else {
                if (data.ev_info.charge_finish) {
                    carStatus.textContent = '{% translate "Charging finished" %}';
                } else if (data.ev_info.charging) {
                    carStatus.textContent = '{% translate "Charging" %}';
                } else if (data.ev_info.batt_heater_status) {
                    carStatus.textContent = '{% translate "Battery heater active" %}';
                } else {
                    carStatus.textContent = '{% translate "Off" %}';
                }
            }
            // Update AC Status
            const acStatus = document.getElementById('overview-ac-status');
            const fanIcon = document.getElementById('fan-icon');
            acStatus.textContent = data.ev_info.ac_status ? '{% translate "On" %}' : '{% translate "Off" %}';
            if (data.ev_info.ac_status) {
                fanIcon.classList.add('spinning');
            } else {
                fanIcon.classList.remove('spinning');
            }
            document.getElementById('overview-last-updated').textContent = data.ev_info.last_updated ?
                new Date(data.ev_info.last_updated).toLocaleString() : 'N/A';

            // Update Charge Bar
            updateChargeBar(data.ev_info.charge_bars, data.ev_info.soc, data.ev_info.charging, data.ev_info.quick_charging);

            updateChargingTimeTbl([
                {power: '1.4kW/120V', time: data.ev_info.limit_chg_time},
                {power: '3kW/240V', time: data.ev_info.full_chg_time},
                {power: '6.6kW', time: data.ev_info.obc_6kw},
            ])

            // Update Maps
            marker = updateMap(data.location.lat, data.location.lon, map, marker, 15);
            overviewMarker = updateMap(data.location.lat, data.location.lon, overviewMap, overviewMarker, 15, true);

            // Update other tabs
            document.getElementById('last_connection').textContent = data.last_connection ?
                new Date(data.last_connection).toLocaleString() : 'N/A';
            document.getElementById('range_acon').textContent = distanceLocalize(data.ev_info.range_acon, 0);
            document.getElementById('range_acoff').textContent = distanceLocalize(data.ev_info.range_acoff, 0);
            document.getElementById('plugged_in').textContent = data.ev_info.plugged_in ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('charging').textContent = data.ev_info.charging ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('quick_charging').textContent = data.ev_info.quick_charging ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('gids').textContent = data.ev_info.gids;
            document.getElementById('counter').textContent = data.ev_info.counter;
            document.getElementById('param21').textContent = data.ev_info.param21;
            document.getElementById('soh').textContent = data.ev_info.soh+"%";
            document.getElementById('remaining_kwh').textContent = (data.ev_info.wh_content/1000).toFixed(2)+" kWh";
            document.getElementById('full_chg_time').textContent = (data.ev_info.full_chg_time === 2047 || data.ev_info.full_chg_time == 0) ? '--:--' : convertMinsToHrsMins(data.ev_info.full_chg_time);
            document.getElementById('6kw_time').textContent = (data.ev_info.obc_6kw === 4095 || data.ev_info.obc_6kw === 2047 || data.ev_info.obc_6kw == 0) ? '--:--' : convertMinsToHrsMins(data.ev_info.obc_6kw);
            document.getElementById('limit_chg_time').textContent = (data.ev_info.limit_chg_time === 2047 || data.ev_info.limit_chg_time == 0) ? '--:--' : convertMinsToHrsMins(data.ev_info.limit_chg_time);
            document.getElementById('car_running').textContent = data.ev_info.car_running ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('charge_bars').textContent = data.ev_info.charge_bars + " / 12";
            document.getElementById('soc').textContent = data.ev_info.soc.toFixed(2)+"%";
            document.getElementById('soc_display').textContent = data.ev_info.soc_display.toFixed(2)+"%";
            document.getElementById('cap_bars').textContent = data.ev_info.cap_bars + " / 12";
            document.getElementById('car_gear').textContent = data.ev_info.car_gear === 0 ? '{% translate "Parked" %}' : (data.ev_info.car_gear === 2 ? '{% translate "Reverse" %}' : '{% translate "Drive" %}');
            document.getElementById('ac_status').textContent = data.ev_info.ac_status ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('obc_6kw_avail').textContent = data.ev_info.obc_6kw_avail ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('batt_heater_avail').textContent = data.ev_info.batt_heater_avail ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('batt_heater_status').textContent = data.ev_info.batt_heater_status ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('ev_last_updated').textContent = data.ev_info.last_updated ?
                new Date(data.ev_info.last_updated).toLocaleString() : 'N/A';
            /*document.getElementById('lat').textContent = data.location.lat || 'N/A';
            document.getElementById('lon').textContent = data.location.lon || 'N/A';*/
            document.getElementById('home').textContent = data.location.home ? '{% translate "Yes" %}' : '{% translate "No" %}';
            document.getElementById('loc_last_updated').textContent = data.location.last_updated ?
                new Date(data.location.last_updated).toLocaleString() : 'N/A';
            document.getElementById('odometer').textContent = data.odometer !== -1 ? data.odometer : '--';
            document.getElementById('map_version').textContent = data.map_version ? data.map_version : '--';
            document.getElementById('tcu_version').textContent = data.tcu_version ? data.tcu_version : '--';
            document.getElementById('tcu_version2').textContent = data.tcu_ver ? data.tcu_ver : '--';
            document.getElementById('navi_version').textContent = data.navi_version ? data.navi_version : '--';
            document.getElementById('carrier').textContent = data.carrier ? data.carrier : '';
            setSignalStrength(data.signal_level);

            // Update connection status color
            const connectionStatus = document.getElementById('connection-status');
            if (data.last_connection) {
                const lastConnectionTime = new Date(data.last_connection).getTime();
                const currentTime = new Date().getTime();
                const diffTime = (currentTime - lastConnectionTime) / 1000; // Difference in seconds
                connectionStatus.className = 'connection-status';
                if (diffTime < 3600) { // Within 1 hour
                    connectionStatus.classList.add('green');
                } else if (diffTime > 1209600) { // Over 2 weeks (14 days)
                    connectionStatus.classList.add('red');
                } else { // Between 1 hour and 2 weeks
                    connectionStatus.classList.add('yellow');
                }
            } else {
                connectionStatus.className = 'connection-status red';
            }

            sendToCarResults.innerHTML = '';
            if (data.send_to_car_location) {
                sendToCarResults.innerText  = `{% translate "Last shared location" %}: ${data.send_to_car_location.name}`;
            } else {
                sendToCarResults.innerText = '{% translate "No past shared location" %}'
            }

            updateCommandState(data.command_result, data.command_requested);
        }

        function updateAlerts() {
            fetch(`/api/alerts/${vin}/`)
                .then(response => response.json())
                .then(alerts => {
                    const table = document.getElementById('alerts-table');
                    const currentIds = new Set(Array.from(table.rows).map(row => parseInt(row.dataset.id)));
                    const newAlerts = alerts.filter(alert => alert.id > lastAlertId);

                    newAlerts.reverse().forEach(alert => {
                        if (!currentIds.has(alert.id)) {
                            const row = document.createElement('tr');
                            row.dataset.id = alert.id;
                            row.className = 'border-b text-gray-600';
                            row.innerHTML = `
                                <td class="py-2">${alert.type_display}</td>
                                <td class="py-2">${new Date(alert.timestamp).toLocaleString()}</td>
                                <td class="py-2">${alert.additional_data || 'N/A'}</td>
                            `;
                            table.insertBefore(row, table.firstChild);
                            if (table.rows.length > 10) {
                                table.deleteRow(-1);
                            }
                        }
                    });

                    if (newAlerts.length > 0) {
                        lastAlertId = Math.max(...alerts.map(a => a.id));
                    }
                })
                .catch(error => console.error('Error fetching alerts:', error));
        }

        sendCommandButton.addEventListener('click', () => {
            if (sendCommandButton.disabled) return;

            const commandType = commandSelect.value;
            fetch(`/api/command/${vin}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ command_type: commandType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification({title: '{% translate "Error sending command" %}', message: data.error ?? data, type: 'error'})
                } else {
                    if (currentSmsConfig && currentSmsConfig.provider === 'ondevice') {
                        window.location.href = `sms:${currentSmsConfig.phone}?body={{ sms_message }}`;
                    }
                }
            })
            .catch(error => {
                console.error('{% translate "Error sending command" %}:', error);
                showNotification({title: '{% translate "Error sending command" %}', message: error.error ?? error, type: 'error'})
            });
        });


        sendToCarButton.addEventListener('click', () => {
            updateSendToCarState(false, true);

            const sendToCarOption = JSON.parse(sendToCarResults.querySelector('input[name="send-to-car-option"]:checked').value);

            fetch(`/api/car/${vin}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ send_to_car_location: sendToCarOption })
            })
            .then(response => response.json())
            .then(data => {
                updateSendToCarState(false, false);
                if (data.error) {
                    showNotification({title: '{% translate "Error sending location to car" %}', message: data.error ?? data, type: 'error'})
                } else {
                    showNotification({message: "{% translate "Location sent!" %}", type: "success"});
                    updateCarUIElements(data);
                }
            })
            .catch(error => {
                updateSendToCarState(false, false);
                console.error('{% translate "Error sending location to car" %}:', error);
                showNotification({title: '{% translate "Error sending location to car" %}', message: error.error ?? error, type: 'error'})
            });
        })

        document.getElementById('send-to-car-search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            updateSendToCarState(false, true);
            map.invalidateSize();
            sendToCarResults.innerHTML = '';

            const searchFieldValue = sendToCarSearch.value.trim();
            let linkMatchResult = mapUrlRegex.exec(searchFieldValue);
            if (linkMatchResult && linkMatchResult.length > 0) {
                fetch('/api/maplink/resolve', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({url: linkMatchResult[0]})
                }).then(response => response.json())
                .then(data => {
                    updateSendToCarState(false, false);
                    if (data.location) {
                        const location = data.location;

                        // Create list element
                        const ul = document.createElement('ul');
                        ul.className = 'space-y-2';
                        const li = document.createElement('li');
                        li.className = 'bg-gray-100 p-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-start';

                        if (location.name === location.address) {
                            location.name = undefined;
                        }

                        const jsonValue = JSON.stringify({lat: location.lat, lon: location.lon, name: (location.name || location.address).substring(0, 32)});

                        li.innerHTML = `
                          <div class="flex items-center space-x-3">
                            <input type="radio" class="h-4 w-4 text-blue-600 rounded" name="send-to-car-option" checked />
                            <div class="flex flex-col">
                              <h3 class="text-sm font-semibold text-gray-800 stc-locname"></h3>
                              <p class="text-sm text-gray-600 stc-locaddr" style="display: ${location.name ? "block" : "none"}"></p>
                            </div>
                          </div>
                        `;

                        li.querySelector('.stc-locname').innerText = location.name || location.address;
                        li.querySelector('.stc-locaddr').innerText = location.address || '{% translate "No address" %}';

                        li.querySelector('input[type="radio"]').value = jsonValue;
                        ul.appendChild(li);
                        sendToCarResults.appendChild(ul);

                        marker = updateMap(location.lat, location.lon, map, marker, 16)
                        updateSendToCarState(true, false);

                    } else {
                        sendToCarResults.innerText = '{% translate "Could not get location from map link" %}'
                    }
                })
                .catch(error => {
                    updateSendToCarState(false, false);
                    console.error(error);
                    sendToCarResults.innerText = '{% translate "Error searching locations" %}: '+error.error ?? error;
                });
                return
            }

            fetch('https://nominatim.openstreetmap.org/search?'+new URLSearchParams({q: searchFieldValue, format: 'json', addressdetails: 1, limit: 5}).toString())
                .then(response => response.json())
                .then(data => {
                    updateSendToCarState(false, false);
                    if (data.length > 0) {
                          // Create list element
                          const ul = document.createElement('ul');
                          ul.className = 'space-y-2';

                          data.forEach(location => {
                            const li = document.createElement('li');
                            li.className = 'bg-gray-100 p-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-start';

                            // Extract address components
                            const address = location.address || {};
                            const addressParts = [
                                (address.road ? [address.road,
                                address.house_number].join(" ") : ''),
                              address.neighbourhood,
                              address.suburb,
                              address.town,
                              address.postcode,
                              address.country
                            ].filter(part => part).join(', ');

                            if (location.name === address.road) {
                                location.name = undefined;
                            }

                            const jsonValue = JSON.stringify({lat: location.lat, lon: location.lon, name: (location.name || address.road).substring(0, 32)});

                            li.innerHTML = `
                              <div class="flex items-center space-x-3">
                                <input type="radio" class="h-4 w-4 text-blue-600 rounded" name="send-to-car-option" />
                                <div class="flex flex-col">
                                  <h3 class="text-sm font-semibold text-gray-800 stc-locname"></h3>
                                  <p class="text-sm text-gray-600 stc-locaddr" style="display: ${location.name ? "block" : "none"}"></p>
                                </div>
                              </div>
                            `;

                            li.querySelector('.stc-locname').innerText = location.name || addressParts;
                            li.querySelector('.stc-locaddr').innerText = addressParts || '{% translate "No address" %}';

                            li.querySelector('input[type="radio"]').value = jsonValue;



                            li.addEventListener('click', (event) => {
                                const checkbox = li.querySelector('div > input[type="radio"]');
                                if (event.target !== checkbox) {
                                    checkbox.checked = !checkbox.checked;
                                }
                                updateSendToCarState(true, false)
                                marker = updateMap(location.lat, location.lon, map, marker, 16)
                            });
                            ul.appendChild(li);
                          });

                          sendToCarResults.appendChild(ul);
                    } else {
                        sendToCarResults.innerText = '{% translate "Search did not find any locations" %}'
                    }
                })
                .catch(error => {
                    updateSendToCarState(false, false);
                    console.error(error);
                    sendToCarResults.innerText = '{% translate "Error searching locations" %}: '+error.error ?? error;
                });
        })

        let firstTimeConnect = true;

        function ws_connect() {
            if (firstTimeConnect) {
                firstTimeConnect = false;
                return
            }
            let reconnect_notif = document.getElementById('reconnecting');
            if (reconnect_notif) {
                reconnect_notif.classList.add('translate-x-full', 'opacity-0');
                reconnect_notif.classList.remove('translate-x-0', 'opacity-100');
                setTimeout(() => {
                    reconnect_notif.remove();
                }, 300);
            }
            showNotification({message: "{% translate "Connection established!" %}", type: "success"});
        }

        function ws_reconnect() {
            if (!document.getElementById('reconnecting'))
                showNotification({message: "{% translate "Reconnecting..." %}", type: "info", persist_id: "reconnecting"});
        }

        function ws_msg(ws_event) {
            const data = JSON.parse(ws_event.data);
            switch (data.type) {
                case 'location':
                case 'tcu_configuration':
                case 'car':
                case 'ev_info':
                    if (data.data.id === carId)
                        updateCarUIElements(data.data);
                    break;
                case 'alert':
                    const alert = data.data;
                    const table = document.getElementById('alerts-table');
                    const row = document.createElement('tr');
                    row.dataset.id = alert.id;
                    row.className = 'border-b text-gray-600';
                    row.innerHTML = `
                        <td class="py-2">${alert.type_display}</td>
                        <td class="py-2">${new Date(alert.timestamp).toLocaleString()}</td>
                        <td class="py-2">${alert.additional_data || 'N/A'}</td>
                    `;
                    table.insertBefore(row, table.firstChild);
                    showNotification({title: `${alert.car.nickname}: ${alert.type_display}`, message: alert.additional_data, type: "notification"});
                    break;
            }
        }

        function ws_close() {
            // unused
        }

        function ws_err(ws_event) {
            // unused
        }

        // Route planner

        function updateRoutePlans() {
            const editDialog = document.getElementById('routeplan-editdialog');
            const routePlansList = document.getElementById('routeplans-list');
            editDialog.style.display = 'none';
            routePlansList.innerHTML = '';
            
            if (routePlans.length === 0) {
                routePlansList.innerHTML = '{% translate 'No route plans added' %}';
            }

            for (let route of routePlans) {
                const frame = document.createElement('div');
                frame.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition';

                const planName = document.createElement('span');
                planName.className = 'text-gray-700 font-medium mx-3';
                planName.innerText = `${routePlans.indexOf(route)+1}. ${route.name}`;

                const actionsFrame = document.createElement('div');
                actionsFrame.className = 'flex space-x-2';

                const editBtn = document.createElement('button');
                editBtn.onclick = () => {editRoutePlan(route.id)};
                editBtn.className = 'px-3 py-1 bg-blue-700 text-white rounded-md hover:bg-blue-600 transition text-sm';
                editBtn.innerText = '{% translate "Edit" %}';

                const deleteBtn = document.createElement('button');
                deleteBtn.onclick = () => {deleteRoutePlan(route.id)};
                deleteBtn.className = 'px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm';
                deleteBtn.innerText = '{% translate "Delete" %}';

                actionsFrame.appendChild(editBtn);
                actionsFrame.appendChild(deleteBtn);

                frame.appendChild(planName);
                frame.appendChild(actionsFrame);

                routePlansList.appendChild(frame);
            }

            routePlansList.style.display = 'block';
        }

        function removeWayPoint(pointNo) {
            const waypointsHolder = document.getElementById('rp-waypoints');
            let point = waypointsHolder.childNodes.values().toArray().find(i => i.id === `rp-waypoint-${pointNo}-form`);
            if (point)
                waypointsHolder.removeChild(point);

            updateCurrentRoutePlanFromForm();
        }

        function openDestCopyDialog() {
            if (!composingRoutePlan.active)
                return;
            const modal = FlowbiteInstances.getInstance('Modal', 'carpin-modal');
            modal.show();
        }

        function updateCurrentRoutePlanFromForm() {
            let mapPoints = [];
            const searchFields = Array.from(document.getElementsByClassName('rp-searchfield'));
            composingRoutePlan = {id: (composingRoutePlan ? composingRoutePlan.id : null), active:(composingRoutePlan ? composingRoutePlan.active : false)};
            composingRoutePlan.name = document.getElementById('routeplan-name').value;
            for (const field of searchFields) {
                if (!field.dataset || !field.dataset.lat || !field.dataset.lon || !field.dataset.name)
                    continue;
                let pointId = 0;
                if (field.id === 'rp-finish') {
                    pointId = 6;
                    composingRoutePlan.finish_lat = parseFloat(field.dataset.lat).toFixed(10);
                    composingRoutePlan.finish_lon = parseFloat(field.dataset.lon).toFixed(10);
                    composingRoutePlan.finish_name = field.dataset.name;
                } else if (field.id.startsWith('rp-waypoint-')) {
                    pointId = parseInt(field.id.replace('rp-waypoint-', ''));
                    composingRoutePlan[`point${pointId}_name`] = field.dataset.name;
                    composingRoutePlan[`point${pointId}_lat`] = parseFloat(field.dataset.lat).toFixed(10);
                    composingRoutePlan[`point${pointId}_lon`] = parseFloat(field.dataset.lon).toFixed(10);
                } else {
                    composingRoutePlan.start_lat = parseFloat(field.dataset.lat).toFixed(10);
                    composingRoutePlan.start_lon = parseFloat(field.dataset.lon).toFixed(10);
                    composingRoutePlan.start_name = field.dataset.name;
                }

                mapPoints.push({name: field.dataset.name, lat: field.dataset.lat, lon: field.dataset.lon, number: pointId});
            }
            composingRoutePlan.count = mapPoints.length;
            routeplanMap.invalidateSize();
            routeplanMap.eachLayer(layer => {routeplanMap.removeLayer(layer)});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(routeplanMap);
            let latlngs = []
            if (mapPoints.length < 1) {
                if (marker) {
                    const carLatLon = [marker.getLatLng().lat, marker.getLatLng().lng];
                    let carIcn = L.icon({
                        iconUrl: staticRes+`car/${carColor}.png`,
                        iconSize:     [42, 25],
                        iconAnchor:   [10, 20],
                    });
                    L.marker(carLatLon, {icon: carIcn}).addTo(routeplanMap).on('click', openDestCopyDialog);
                    latlngs.push(carLatLon);
                    routeplanMap.fitBounds(latlngs, {padding: [12, 12]});
                }
            }
            for (const mapPnt of mapPoints) {
                const latLng = [mapPnt.lat, mapPnt.lon];
                let markerIcn = L.icon({
                    iconUrl: staticRes+'chanicons/'+(mapPnt.number === 0 ? 'start.png' : (mapPnt.number === 6 ? 'destination.png' : `waypoint${mapPnt.number}.png`)),
                    iconSize:     [29, 32],
                    iconAnchor:   [5, 32],
                    popupAnchor: [16, -30],
                    tooltipAnchor: [16, -30],
                });

                let marker = L.marker(latLng, {icon: markerIcn})
                marker.bindPopup(mapPnt.name);
                marker.addTo(routeplanMap);
                latlngs.push(latLng);
            }
            if (mapPoints.length > 0) {
                updateRoutePlannerState((mapPoints.length > 1 && document.getElementById('routeplan-name').value.length > 0), false);
                L.polyline(latlngs, {
                            color: 'red',
                            weight: 3,
                            opacity: 0.5,
                            smoothFactor: 1
                        }).addTo(routeplanMap);
                if (marker) {
                    const carLatLon = [marker.getLatLng().lat, marker.getLatLng().lng];
                    let carIcn = L.icon({
                        iconUrl: staticRes+`car/${carColor}.png`,
                        iconSize:     [42, 25],
                        iconAnchor:   [10, 20],
                    });
                    L.marker(carLatLon, {icon: carIcn}).addTo(routeplanMap).on('click', openDestCopyDialog);
                    latlngs.push(carLatLon);
                }
                routeplanMap.fitBounds(latlngs, {padding: [12, 12]});
            }
        }

        function routePlanPointSearch(event) {
            event.preventDefault();
            const searchField = event.target.getElementsByClassName('rp-searchfield')[0];
            if (searchField.value) {
                updateRoutePlannerState(false, true);
                map.invalidateSize();

                const planPointResults = event.target.getElementsByClassName("rp-search-results")[0]
                planPointResults.innerHTML = '';

                const searchFieldValue = searchField.value.trim();
                let linkMatchResult = mapUrlRegex.exec(searchFieldValue);
                if (linkMatchResult && linkMatchResult.length > 0) {
                    fetch('/api/maplink/resolve', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({url: linkMatchResult[0]})
                    }).then(response => response.json())
                    .then(data => {
                        updateRoutePlannerState(false, false);
                        if (data.location) {
                            const location = data.location;

                            // Create list element
                            const ul = document.createElement('ul');
                            ul.className = 'space-y-2';
                            const li = document.createElement('li');
                            li.className = 'bg-gray-100 p-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-start';

                            if (location.name === location.address) {
                                location.name = undefined;
                            }


                            searchField.dataset.lat = location.lat;
                            searchField.dataset.lon = location.lon;
                            searchField.dataset.addr = location.address || '{% translate "No address" %}';
                            searchField.dataset.name = location.name;
                            if (location.name)
                                searchField.value = `${location.name}, ${location.address}`;
                            else
                                searchField.value = location.address || '{% translate "No address" %}';

                            updateCurrentRoutePlanFromForm();
                        } else {
                            planPointResults.innerText = '{% translate "Could not get location from map link" %}'
                        }
                    })
                    .catch(error => {
                        updateRoutePlannerState(false, false);
                        console.error(error);
                        planPointResults.innerText = '{% translate "Error searching locations" %}: '+error.error ?? error;
                    });
                    return
                }

                fetch('https://nominatim.openstreetmap.org/search?'+new URLSearchParams({q: searchFieldValue, format: 'json', addressdetails: 1, limit: 5}).toString())
                    .then(response => response.json())
                    .then(data => {
                        updateRoutePlannerState(false, false);
                        if (data.length > 0) {
                              // Create list element
                              const ul = document.createElement('ul');
                              ul.className = 'space-y-2';

                              data.forEach(location => {
                                const li = document.createElement('li');
                                li.className = 'bg-gray-100 p-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-start';

                                // Extract address components
                                const address = location.address || {};
                                const addressParts = [
                                    (address.road ? [address.road,
                                    address.house_number].join(" ") : ''),
                                  address.neighbourhood,
                                  address.suburb,
                                  address.town,
                                  address.postcode,
                                  address.country
                                ].filter(part => part).join(', ');

                                if (location.name === address.road) {
                                    location.name = undefined;
                                }

                                const jsonValue = JSON.stringify({lat: location.lat, lon: location.lon, name: (location.name || address.road).substring(0, 32)});

                                li.innerHTML = `
                                  <div class="flex items-center space-x-2">
                                    <input type="radio" class="h-4 w-4 text-blue-600 rounded" name="send-to-car-option" />
                                    <div class="flex flex-col">
                                      <h3 class="text-sm font-semibold text-gray-800 stc-locname"></h3>
                                      <p class="text-sm text-gray-600 stc-locaddr" style="display: ${location.name ? "block" : "none"}"></p>
                                    </div>
                                  </div>
                                `;

                                li.querySelector('.stc-locname').innerText = location.name || addressParts;
                                li.querySelector('.stc-locaddr').innerText = addressParts || '{% translate "No address" %}';

                                li.querySelector('input[type="radio"]').value = jsonValue;



                                li.addEventListener('click', (event) => {
                                    const checkbox = li.querySelector('div > input[type="radio"]');
                                    if (event.target !== checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                    }
                                    searchField.dataset.lat = location.lat;
                                    searchField.dataset.lon = location.lon;
                                    searchField.dataset.addr = addressParts || '{% translate "No address" %}';
                                    searchField.dataset.name = location.name;
                                    if (location.name)
                                        searchField.value = `${location.name}, ${addressParts}`;
                                    else
                                        searchField.value = addressParts || '{% translate "No address" %}';
                                    planPointResults.innerHTML = '';

                                    updateCurrentRoutePlanFromForm();
                                });
                                ul.appendChild(li);
                              });

                              planPointResults.appendChild(ul);
                        } else {
                            planPointResults.innerText = '{% translate "Search did not find any locations" %}'
                        }
                    })
                    .catch(error => {
                        updateRoutePlannerState(false, false);
                        console.error(error);
                        planPointResults.innerText = '{% translate "Error searching locations" %}: '+error.error ?? error;
                    });
            }
        }

        function addWayPoint(number=null, internal=false) {
            const waypointsHolder = document.getElementById('rp-waypoints');
            if (waypointsHolder.children.length > 4) {
                showNotification({title: '{% translate 'Cannot add a new waypoint' %}', message: '{% translate "Maximum number of waypoints reached" %}', type: 'warning'})
                return;
            }
            const newWaypointNo = number ?? waypointsHolder.children.length+1;
            const waypointForm = document.createElement('form');
            waypointForm.className = 'rp-wp-search mt-2';
            waypointForm.id = `rp-waypoint-${newWaypointNo}-form`;
            waypointForm.onsubmit = routePlanPointSearch

            const inputHolder = document.createElement('div');
            inputHolder.className = 'flex flex-row';

            const inputField = document.createElement('input');
            inputField.type = 'search';
            inputField.required = true;
            inputField.minLength = 2;
            inputField.placeholder = "{% translate "Search for locations or enter google/apple maps link" %}";
            inputField.id = `rp-waypoint-${newWaypointNo}`;
            inputField.className = 'rp-searchfield w-full p-1 border rounded mt-1';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'ml-2 mt-1 text-gray-500 hover:text-gray-700 focus:outline-none bg-transparent border-none text-lg font-semibold';
            removeBtn.innerText = 'x';
            removeBtn.type = 'button';
            removeBtn.addEventListener('click', () => {removeWayPoint(newWaypointNo)});

            inputHolder.appendChild(inputField);
            inputHolder.appendChild(removeBtn);

            const inputLabel = document.createElement('label');
            inputLabel.setAttributeNS(null, 'for', inputField.id);
            inputLabel.className = 'routeplan-title';
            const staticPath = staticRes+`chanicons/waypoint${newWaypointNo}.png`;
            inputLabel.innerHTML = `<img class="routeplan-icon" src="${staticPath}"/> {% translate "Waypoint" %} ${newWaypointNo}`;

            const searchResultsHolder = document.createElement('div');
            searchResultsHolder.className = 'rp-search-results mt-2';

            waypointForm.appendChild(inputLabel)
            waypointForm.appendChild(inputHolder);
            waypointForm.appendChild(searchResultsHolder);

            waypointsHolder.appendChild(waypointForm);
            if (!internal)
                routeplanMap.invalidateSize();
        }

        function setCarLocationInPlan(pos) {
            const startBox = document.getElementById('rp-start');
            const endBox = document.getElementById('rp-finish');
            const activeBox = pos === 0 ? startBox : endBox;
            activeBox.value = carName;
            activeBox.dataset = {};
            activeBox.dataset.lat = marker.getLatLng().lat;
            activeBox.dataset.lon = marker.getLatLng().lng;
            activeBox.dataset.addr = '{% translate "No address" %}';
            activeBox.dataset.name = carName;
            updateCurrentRoutePlanFromForm();
        }

        function saveRoutePlan() {
            composingRoutePlan.name = document.getElementById('routeplan-name').value;
            routePlans = routePlans.sort((a,b)=>{return new Date(b.created_at) - new Date(a.created_at)})
            if (composingRoutePlan.id) {
                let idx = routePlans.indexOf(routePlans.find(i => i.id === composingRoutePlan.id));
                if (idx !== -1) {
                    routePlans[idx] = composingRoutePlan;
                }
                routePlans = routePlans.sort(function(x,y){ return x.id === composingRoutePlan.id ? -1 : y.id === composingRoutePlan.id ? 1: 0; })
            } else {
                routePlans.unshift(composingRoutePlan);
            }
            updateRoutePlannerState(false, true);
            fetch(`/api/car/${vin}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ route_plans: routePlans })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            updateRoutePlannerState(false, false);
                            showNotification({title: '{% translate "Error saving the route plan" %}', message: data.error ?? data, type: 'error'})
                        } else {
                            showNotification({message: "{% translate "Route plan saved!" %}", type: "success"});
                            exitRoutePlanEditor();
                            updateCarUIElements(data);
                        }
                    })
                    .catch(error => {
                        updateRoutePlannerState(true, false);
                        console.error('{% translate "Error saving the route plan" %}:', error);
                        showNotification({title: '{% translate "Error saving the route plan" %}', message: error.error ?? error, type: 'error'})
                    });
        }

        function exitRoutePlanEditor() {
            composingRoutePlan = {id: null};
            const editDialog = document.getElementById('routeplan-editdialog');
            const routePlansList = document.getElementById('routeplans');
            const rpStart = document.getElementById('rp-start');
            const rpFinish = document.getElementById('rp-finish');
            const rpName = document.getElementById('routeplan-name');
            routePlansList.style.display = 'block';
            editDialog.style.display = 'none';
            document.getElementById('rp-waypoints').innerHTML = '';
            rpStart.value = '';
            rpFinish.value = '';
            rpName.value = '';
            Object.keys(rpStart.dataset).forEach(dataKey => {
                delete rpStart.dataset[dataKey];
            });
            Object.keys(rpFinish.dataset).forEach(dataKey => {
                delete rpFinish.dataset[dataKey];
            });
            updateCurrentRoutePlanFromForm();
        }

        function addNewPlan() {
            if (routePlans.length > 4) {
                showNotification({title: '{% translate "Cannot add new route plan" %}', message: '{% translate "You have too many route plans, please delete one and try again." %}', type: 'error'})
                return
            }
            composingRoutePlan.active = true;
            const editDialog = document.getElementById('routeplan-editdialog');
            const routePlansList = document.getElementById('routeplans');
            routePlansList.style.display = 'none';
            editDialog.style.display = 'block';
            document.getElementById('rp-start-form').onsubmit = routePlanPointSearch;
            document.getElementById('rp-finish-form').onsubmit = routePlanPointSearch;
            document.getElementById('routeplan-submit').onclick = saveRoutePlan;
            updateRoutePlannerState(false, false);
            updateCurrentRoutePlanFromForm();
        }

        function editRoutePlan(id) {
            const routePlanObj = routePlans.find(p => p.id === id);
            if (routePlanObj) {
                const editDialog = document.getElementById('routeplan-editdialog');
                const routePlansList = document.getElementById('routeplans');
                const rpStart = document.getElementById('rp-start');
                const rpFinish = document.getElementById('rp-finish');
                const rpName = document.getElementById('routeplan-name');
                routePlansList.style.display = 'none';
                editDialog.style.display = 'block';
                document.getElementById('rp-start-form').onsubmit = routePlanPointSearch;
                document.getElementById('rp-finish-form').onsubmit = routePlanPointSearch;
                document.getElementById('routeplan-submit').onclick = saveRoutePlan;

                composingRoutePlan = routePlanObj;
                composingRoutePlan.active = true;
                rpName.value = routePlanObj.name;
                if (composingRoutePlan.start_name) {
                    rpStart.value = composingRoutePlan.start_name;
                    rpStart.dataset.name = composingRoutePlan.start_name;
                    rpStart.dataset.address = composingRoutePlan.address;
                }
                if (composingRoutePlan.start_lat && composingRoutePlan.start_lon) {
                    rpStart.dataset.lat = composingRoutePlan.start_lat;
                    rpStart.dataset.lon = composingRoutePlan.start_lon;
                }
                if (composingRoutePlan.finish_name) {
                    rpFinish.value = composingRoutePlan.finish_name;
                    rpFinish.dataset.name = composingRoutePlan.finish_name;
                    rpFinish.dataset.address = composingRoutePlan.address;
                }
                if (composingRoutePlan.finish_lat && composingRoutePlan.finish_lon) {
                    rpFinish.dataset.lat = composingRoutePlan.finish_lat;
                    rpFinish.dataset.lon = composingRoutePlan.finish_lon;
                }
                for (let num = 1; num < 6; num++) {
                    if (composingRoutePlan[`point${num}_name`] && composingRoutePlan[`point${num}_lat`] && composingRoutePlan[`point${num}_lon`]) {
                        addWayPoint(num, true);
                        const inputForm = document.getElementById(`rp-waypoint-${num}`);
                        inputForm.value = composingRoutePlan[`point${num}_name`];
                        inputForm.dataset.name = composingRoutePlan[`point${num}_name`];
                        inputForm.dataset.lat = composingRoutePlan[`point${num}_lat`];
                        inputForm.dataset.lon = composingRoutePlan[`point${num}_lon`];
                    }
                }

                updateCurrentRoutePlanFromForm();
            }
        }

        function deleteRoutePlan(id) {
            const routePlanObj = routePlans.find(p => p.id === id);
            if (routePlanObj) {
                if (confirm('{% translate 'Are you sure you want to delete this route plan?' %}')) {
                    routePlans = routePlans.filter(p => p.id !== routePlanObj.id);
                    fetch(`/api/car/${vin}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ route_plans: routePlans })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showNotification({title: '{% translate "Error deleting the route plan" %}', message: data.error ?? data, type: 'error'})
                        } else {
                            showNotification({message: "{% translate "Route plan removed!" %}", type: "success"});
                            updateCarUIElements(data);
                        }
                    })
                    .catch(error => {
                        console.error('{% translate "Error deleting the route plan" %}:', error);
                        showNotification({title: '{% translate "Error deleting the route plan" %}', message: error.error ?? error, type: 'error'})
                    });
                }
            }
        }

        function updateFvtChnItems() {
            let channelElems = Array.from(document.getElementById('favorite-body').getElementsByClassName('datachannel'));
            for (let i = 1; i < channelElems.length; i++) {
                const realPos = i+1;
                const channelElem = channelElems[i];
                const iconElem = channelElem.querySelector('img');
                const nameElem = channelElem.querySelector('.datachannel-name');
                iconElem.src = '';
                nameElem.textContent = "{% translate 'No selected channel' %}";
                if (realPos in fvtChnData) {
                    const channelId = parseInt(fvtChnData[realPos]);
                    if (channelId >= 0x1000 && channelId <= 0x100F) {
                        const customChanId = channelId-0x1000;
                        if (customChnData.hasOwnProperty(customChanId)) {
                            const channel = customChnData[customChanId];
                            nameElem.textContent = channel.name;
                            iconElem.src = staticRes+"chanicons/"+channel.icon;
                            channelElem.classList.remove('text-gray-500')
                        }
                    } else if (allChannels.find(i => i['id'] === channelId)) {
                        const channel = allChannels.find(i => i['id'] === channelId);
                        nameElem.textContent = channel.name;
                        iconElem.src = staticRes+channel.icon;
                        channelElem.classList.remove('text-gray-500')
                    } else {
                        channelElem.classList.add('text-gray-500')
                    }
                } else {
                    channelElem.classList.add('text-gray-500')
                }
            }
        }

        function editFvtChn(pos) {
            editFvtChnPos = pos;
            let customChanItems = document.getElementById('f-4-body');
            customChanItems.innerHTML = '';
            for (let id in Object.keys(customChnData)) {
                let chanData = customChnData[id];
                const chanId = 0x1000+parseInt(id);
                const button = document.createElement('button');
                button.onclick = () => {saveFvtChn(chanId)}
                button.type = 'button'
                button.className = 'flex border-gray-300 border border-t-0 border-x-0 items-center justify-between w-full text-gray-900 text-md font-medium rtl:text-right p-1'

                const span = document.createElement('span');

                const img = document.createElement('img');
                img.className = "inline h-4 mr-2"
                img.src = staticRes+"chanicons/"+chanData.icon;
                span.appendChild(img);
                span.appendChild(document.createTextNode(chanData.name))
                button.appendChild(span);
                customChanItems.appendChild(button);
            }
            FlowbiteInstances.getInstance('Modal', 'fvtchn-modal').show();
        }

        function saveFvtChn(id) {
            saveChanInfoButton.disabled = "";
            FlowbiteInstances.getInstance('Modal', 'fvtchn-modal').hide();
            fvtChnData[editFvtChnPos] = id;
            updateFvtChnItems();
        }

        function clrFvtChn(pos) {
            if (fvtChnData.hasOwnProperty(pos)) {
                saveChanInfoButton.disabled = "";
                delete fvtChnData[pos];
                updateFvtChnItems();
            }
        }

        function updateCustomChnItems() {
            let channelElems = Array.from(document.getElementById('custom-channels-body').getElementsByClassName('datachannel'));
            for (let i = 0; i < channelElems.length; i++) {
                const channelElem = channelElems[i];
                const iconElem = channelElem.querySelector('img');
                const nameElem = channelElem.querySelector('.datachannel-name');
                iconElem.src = '';
                nameElem.textContent = "{% translate 'No content' %}";
                if (i in customChnData) {
                    channelElem.classList.remove('text-gray-500')
                    const channel = customChnData[i];
                    nameElem.textContent = channel.name;
                    iconElem.src = `${staticRes}chanicons/${channel.icon}`;
                } else {
                    channelElem.classList.add('text-gray-500')
                }
            }
        }

        function clrCustomChn(pos) {
            if (customChnData.hasOwnProperty(pos)) {
                saveChanInfoButton.disabled = "";
                delete customChnData[pos];
                updateCustomChnItems();
            }
        }

        function editCustomChn(pos) {
            editCustomChnPos = pos;
            document.getElementById('edit-customchnform').onsubmit = saveCustomChn;
            let channelElem = {name: '', icon: 'info.png', url: '', location: false};
            if (customChnData.hasOwnProperty(pos)) {
                channelElem = customChnData[pos];
            }
            document.getElementById('chan-iconpreview').src = staticRes+'chanicons/'+channelElem.icon;
            document.getElementById('chan-name').value = channelElem.name;
            document.getElementById('chan-icon').value = channelElem.icon;
            document.getElementById('chan-url').value = channelElem.url;
            document.getElementById('chan-location').checked = channelElem.location;
            FlowbiteInstances.getInstance('Modal', 'customchn-modal').show();
        }

        function saveCustomChn(event) {
            event.preventDefault();
            saveChanInfoButton.disabled = "";
            FlowbiteInstances.getInstance('Modal', 'customchn-modal').hide();
            customChnData[editCustomChnPos] = {
                name: document.getElementById('chan-name').value,
                icon: document.getElementById('chan-icon').value,
                url: document.getElementById('chan-url').value,
                location: document.getElementById('chan-location').checked,
            }
            updateCustomChnItems();
        }

        function saveCarwingsSettings() {
            updateCarwingsState(false, true);
            fetch(`/api/car/${vin}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ favorite_channels: fvtChnData, custom_channels: customChnData }),
            })
            .then(response => response.json())
            .then(data => {
                updateCarwingsState(true, false);
                if (data.error) {
                    showNotification({title: '{% translate "Error saving CARWINGS settings" %}', message: data.error ?? data, type: 'error'})
                } else {
                    showNotification({message: "{% translate "CARWINGS settings saved!" %}", type: "success"});
                    updateCarUIElements(data);
                }
            })
            .catch(error => {
                updateCarwingsState(true, false);
                console.error('{% translate "Error saving CARWINGS settings" %}:', error);
                showNotification({title: '{% translate "Error saving CARWINGS settings" %}', message: error.error ?? error, type: 'error'})
            });
        }

        updateCarData();
        updateAlerts();

    </script>
{% endblock %}